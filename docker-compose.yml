# AMFbot Suite - Docker Compose Configuration
# https://github.com/amfbot/amfbot-suite

services:
  # ============================================================
  # AMFbot Core Agent
  # ============================================================
  amfbot-core:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: amfbot-core
    restart: unless-stopped
    environment:
      - OLLAMA_HOST=http://ollama:11434
      - MEDIA_GEN_URL=http://media-gen:8765
      - NODE_ENV=production
    volumes:
      - amfbot-data:/app/data
      - ~/.amfbot:/root/.amfbot
    ports:
      - "3000:3000"
    depends_on:
      - ollama
    networks:
      - amfbot-network

  # ============================================================
  # Media Generation Service (LTX-Video & Flux)
  # ============================================================
  media-gen:
    build:
      context: ./modules/media-gen
      dockerfile: Dockerfile
    container_name: amfbot-media-gen
    restart: unless-stopped
    environment:
      - AMFBOT_MODELS_DIR=/models
      - AMFBOT_OUTPUT_DIR=/outputs
      - AMFBOT_MEDIA_PORT=8765
      - AMFBOT_MEDIA_HOST=0.0.0.0
    volumes:
      - models-data:/models
      - outputs-data:/outputs
    ports:
      - "8765:8765"
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    networks:
      - amfbot-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8765/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ============================================================
  # Ollama - Local LLM Engine
  # ============================================================
  ollama:
    image: ollama/ollama:latest
    container_name: amfbot-ollama
    restart: unless-stopped
    volumes:
      - ollama-data:/root/.ollama
    ports:
      - "11434:11434"
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    networks:
      - amfbot-network
    healthcheck:
      test: ["CMD", "ollama", "list"]
      interval: 30s
      timeout: 10s
      retries: 3

# ============================================================
# Networks
# ============================================================
networks:
  amfbot-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

# ============================================================
# Volumes
# ============================================================
volumes:
  amfbot-data:
    driver: local
  models-data:
    driver: local
  outputs-data:
    driver: local
  ollama-data:
    driver: local
